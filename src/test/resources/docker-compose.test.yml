# 테스트 환경에서 사용할 Docker 컨테이너를 정의합니다.
# Testcontainers가 이 파일을 사용하여 Redis와 Kafka 서비스를 실행합니다.
version: '3.8'

services:
  # 테스트용 Redis 서비스
  redis-test:
    image: "redis:6.2-alpine"
    # 포트는 Testcontainers가 호스트의 임의 포트에 매핑하므로 외부에 노출할 필요가 없습니다.
    ports:
      - "6379"

  # Kafka가 의존하는 Zookeeper 서비스
  zookeeper-test:
    image: confluentinc/cp-zookeeper:7.3.2
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  # 테스트용 Kafka 서비스
  kafka-test:
    image: confluentinc/cp-kafka:7.3.2
    depends_on:
      - zookeeper-test
    ports:
      - "9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper-test:2181'
      # Spring Boot 애플리케이션(Host)이 Docker 내부의 Kafka에 접근할 수 있도록 설정
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-test:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
